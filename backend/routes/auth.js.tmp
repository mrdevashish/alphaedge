import express from 'express'; import bcrypt from 'bcryptjs'; import jwt from 'jsonwebtoken';
import db from '../lib/db.js'; const router=express.Router(); const JWT_SECRET=process.env.JWT_SECRET||'dev';
router.post('/register', async (req,res)=>{
  const {name='',email='',password=''}=req.body||{}; if(!email||!password) return res.status(400).json({message:'email/password required'});
  if(db.users.find(email)) return res.status(409).json({message:'user exists'});
  const hash = await bcrypt.hash(password,10); db.users.upsert({email,name,hash});
  return res.json({ok:true});
});
router.post('/login', async (req,res)=>{
  const {email='',password=''}=req.body||{}; const u=db.users.find(email); if(!u) return res.status(401).json({message:'invalid'});
  const ok = await bcrypt.compare(password,u.hash||''); if(!ok) return res.status(401).json({message:'invalid'});
  const token=jwt.sign({email},JWT_SECRET,{expiresIn:'7d'}); res.json({token,email});
});
export default router;
